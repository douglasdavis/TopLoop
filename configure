#!/usr/bin/env bash


type root-config >/dev/null 2>&1 || { echo >&2 "root-config not found. Aborting."; exit 1; }

while [[ $# > 1 ]]; do
    key="$1"
    case $key in
	--boost-inc)
	    BOOSTINC="$2"
	    shift
	    ;;
	--boost-lib)
	    BOOSTLIB="$2"
	    shift
	    ;;
	*)
	    ;;
    esac
    shift
done

if [ -z "$BOOSTINC" ]; then
    BOOSTINC="-I/usr/local/include -I/usr/include"
else
    BOOSTINC="-I$BOOSTINC"
fi

if [ -z "$BOOSTLIB" ]; then
    BOOSTLIB="-L/usr/local/lib -L/usr/lib"
else
    BOOSTLIB="-L$BOOSTLIB"
fi

TL_BASE=$PWD
mkdir -p $PWD/lib

ARCH=`uname`
if [ $ARCH == "Darwin" ]; then
	LIBSUFFIX="dylib"
else
	LIBSUFFIX="so"
fi

cat > $TL_BASE/Makefile.common <<EOF1
#####################################################################
## DO NOT EDIT                                                     ##
## Auto Generated [common] Makefile for the TL (Top Loop) library  ## 
## configure Author: Douglas Davis < ddavis@phy.duke.edu >         ##
##                                 < douglas.davis@cern.ch >       ##
#####################################################################

CXX := c++
CXXFLAGS = -fPIC -Wall -O2 `root-config --cflags` -I${TL_BASE}/include \
-I{TL_BASE}/include/TopLoop ${BOOSTINC}
LDFLAGS  = -L${TL_BASE}/lib ${BOOSTLIB} `root-config --glibs` -lTreePlayer \
-lboost_filesystem -lboost_system
LIBSUFFIX = ${LIBSUFFIX}

EOF1

cat > $TL_BASE/Makefile <<EOF2
###################################################################
## DO NOT EDIT                                                   ##
## Auto Generated Makefile for the TL (Top Loop) library         ##
## configure Author: Douglas Davis < ddavis@phy.duke.edu >       ##
##                                 < douglas.davis@cern.ch >     ##
###################################################################

include Makefile.common

TARGET  := lib/libTopLoop.\$(LIBSUFFIX)

HEADERS = include/TopLoop/AnaBase.h include/TopLoop/Job.h \
include/TopLoop/FileManager.h

all: \$(TARGET)

\$(TARGET): src/AnaBase.o src/Job.o src/FileManager.o src/TLdict.o
	-@echo "[TL] Building \$@";\$(CXX) -shared -o \$@ $^ \$(LDFLAGS)
	-@echo "[TL] Done"


src/TLdict.o: src/TLdict.cxx \$(HEADERS) include/TopLoop/LinkDef.h
	-@echo "[TL] Building \$@";\$(CXX) \$(CXXFLAGS) \
-I${TL_BASE}/include/TopLoop -o \$@ -c $<

src/TLdict.cxx: \$(HEADERS)
	-@echo "[TL] Generating \$@";rootcling -f \$@ -I${TL_BASE}/include/TopLoop \
-I${TL_BASE}/include AnaBase.h FileManager.h Job.h Utils.h LinkDef.h

src/AnaBase.o: src/AnaBase.cxx \$(HEADERS)
	-@echo "[TL] Building \$@";\$(CXX) \$(CXXFLAGS) -o \$@ -c $<

src/Job.o: src/Job.cxx \$(HEADERS)
	-@echo "[TL] Building \$@";\$(CXX) \$(CXXFLAGS) -o \$@ -c $<

src/FileManager.o: src/FileManager.cxx \$(HEADERS)
	-@echo "[TL] Building \$@";\$(CXX) \$(CXXFLAGS) -o \$@ -c $<

clean:
	-@\$(RM) src/*.o lib/*.\$(LIBSUFFIX) src/*TLdict*

EOF2
